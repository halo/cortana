server {
  # Catch all *.localhost
  server_name ~^(.*)\.localhost$;

  # Catch all *.test
  server_name ~^(.*)\.test$;

  # Catch all *.serveo.net
  server_name ~^(.*)\.serveo.net$;

  # Catch all *.xip.io
  server_name "~^(.*)(\.\d+){4}\.xip\.io$";

  listen <%= @port %>;
  passenger_enabled on;

  # Infer repository location from domain name.
  set $tdl $1;
  set $_root <%= @projects_path %>/$1/$1/public;
  if ($tdl ~ '^(.*)\.(.*)$') {
    # Subdomains still lead to the same app directory
    set $_root <%= @projects_path %>/$2/$2/public;
  }
  root $_root;

  set $real_host $host;
  # strip '.1.2.3.4.xip.io' from the host
  if ($real_host ~ '(.*)(\.\d+){4}\.xip\.io$') {
    set $real_host $1.test;
  }
  # pass the modified host to the app
  proxy_set_header Host $real_host;
}
